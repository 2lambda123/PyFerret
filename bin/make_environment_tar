#! /bin/csh

echo ""
if ( $#argv != 2 ) then
   echo "Usage:  $0  <svn_repository>  <target_dir> "
   echo ""
   echo "    The required files will be extracted from <svn_repository> "
   echo "    (e.g., 'file:///home/users/tmap/svn/repos/ferret/trunk') "
   echo "    to a temporary directory which this script will create. "
   echo "    Font files and lib files are NOT included in the tar file "
   echo "    generated.  The gzipped tar file fer_environment.tar.gz "
   echo "    will be written in <target_dir>, which must already exist. "
   echo ""
   exit 1
endif

set info = `svn info "$1"`
if ( "${info}" == "" ) then
#  svn has printed an appropriate error message
#  (but still returned a zero status)
   echo ""
   exit 1
endif
set repository = "$1"

if ( ! -d "$2" ) then
   echo "$2 does not exist "
   echo ""
   exit 1
endif
# Make sure target_dir is a full pathname
set target_dir = ` cd "$2" ; pwd`

# Make a clean temporary directory for the tar file contents
set temp_dir = "/var/tmp/fer_env_$$"
rm -fr ${temp_dir}
mkdir ${temp_dir}
cd ${temp_dir}

# Checkout the required files
echo "Extracting FERRET environment files "
echo "from ${repository} "
echo "to ${temp_dir} "
echo "   shell scripts"
svn checkout -q ${repository}/bin
echo "   journal files"
svn checkout -q ${repository}/jnls
echo "   external function source files"
svn checkout -q ${repository}/external_functions
echo "   palettes"
svn checkout -q ${repository}/palettes

# Move files into thier proper position
echo "Doing a bit of rearranging"
mv jnls/* .
rm -rf jnls
mv palettes ppl
mkdir ext_func
mv external_functions ext_func/src

# Remove files that should not be distributed
echo "Removing clutter"
rm -f bin/Fapropos* >& /dev/null
rm -f bin/Fhelp* >& /dev/null
rm -f bin/Findex* >& /dev/null
rm -f bin/Finstall.[^c]* >& /dev/null
rm -f bin/Ftoc* >& /dev/null
rm -f bin/ferret_paths*_template >& /dev/null
rm -f bin/make_*_tar >& /dev/null
rm -fr bin/fonts_* >& /dev/null
rm -fr bin/build_fonts/original

# Now set up the proper symbolic links
echo "Setting up symbolic links"
cd bin
ln -s Fdescr Fdesc
ln -s Fgrids Fgrid
ln -s Fprint_template Fprint
cd ..

# Create the tar file
set ctar_file = "${target_dir}/fer_environment.tar.gz"
echo ""
echo "The tar file will be created from the contents of "
echo "${temp_dir}"
echo "(which can now be examined or tweaked from another shell/window)"
echo ""
echo -n "Create gzipped tar file ${ctar_file} (y/n)? "
set ans = $<
while ( ("${ans}" != "y") && ("${ans}" != "n") )
   echo -n "Answer either y or n: "
   set ans = $<
end
if ( "${ans}" == "y" ) then
   echo ""
   rm -f "${ctar_file}"
   tar cvzf "${ctar_file}" --exclude .svn *
   echo ""
   ls -l "${ctar_file}"
else
   echo ""
   echo "Tar file NOT created"
endif

# Clean up
echo ""
echo "Cleaning up - removing ${temp_dir}"
cd "${target_dir}"
rm -fr "${temp_dir}"
echo ""

